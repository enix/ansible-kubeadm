---
- name: 'Find nodes to join'
  set_fact:
    nodes_to_join: >-
      {{ q('inventory_hostnames', kube_cp_group ~ ':' ~ kube_worker_group)
         |map('extract', hostvars)
         |selectattr('_kubelet_config_stat', 'defined')
         |rejectattr('_kubelet_config_stat.stat.exists')
         |map(attribute='inventory_hostname')|list }}
  run_once: true

- name: 'Create bootstrap token'
  when: nodes_to_join|length > 0
  block:
    - name: 'Retrieve a valid bootstrap token'
      import_role:
        name: bootstrap_token_get

    - name: 'Create bootstrap token if no valid found'
      command: kubeadm token create
      run_once: true
      delegate_to: '{{ cp_node }}'
      when: _valid_bootstrap_tokens|length == 0

    - name: 'Retrieve a valid bootstrap token'
      import_role:
        name: bootstrap_token_get
      when: _valid_bootstrap_tokens|length == 0
