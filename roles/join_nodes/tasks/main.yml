---
- name: 'Retrieve variable from control-plane'
  set_fact:
    control_plane_endpoint: '{{ hostvars[cp_node].control_plane_endpoint }}'
    _control_plane: '{{ _control_plane }}'

- name: "Find node related IP"
  include_role:
    name: find_ip

- name: "Get CA fingerprint "
  import_tasks: ca_info.yml
  when: not(groups.cp_running|default([])|length == 0 and ansible_check_mode)

- name: 'Display JoinConfig'
  debug:
    msg: '{{ lookup("template", role_path ~ "/templates/join_config.j2").splitlines() }}'
    verbosity: 1

- name: 'Join node that are not already joined'
  command: >-
    kubeadm join --config=/dev/stdin
    {% if _control_plane and enable_kubeadm_patches|bool -%}
      {% if _target_kube_version is version("1.22", ">=") -%}
      {% elif _target_kube_version is version("1.19", ">=") -%}
      --experimental-patches {{ kubeadm_patch_dir }}
      {%- endif %}
    {%- endif -%}
  args:
    stdin: '{{ lookup("template", role_path ~ "/templates/join_config.j2") }}'
    creates: '{{ _kubelet_config_path }}'
  register: kubeadm_node_join

- name: 'Display output of "kubeadm join"'
  debug:
    var: kubeadm_node_join
    verbosity: 1
